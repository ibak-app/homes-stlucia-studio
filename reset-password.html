<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set New Password — homes.stlucia</title>
  <meta name="description" content="Set a new password for your homes.stlucia account.">
  <link rel="stylesheet" href="assets/css/style.css">
  <script defer data-domain="homes.stlucia.studio" src="https://plausible.io/js/script.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0GXK2QMVPZ"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-0GXK2QMVPZ');</script>
  <!-- Analytics: Facebook Pixel -->
  <script>!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');fbq('init','1403025764621663');fbq('track','PageView');</script>
</head>
<body>
  <a href="#main" class="skip-link">Skip to content</a>

  <main id="main" class="auth-page">
    <div class="auth-card">

      <div class="auth-card__logo">
        <span>homes.</span>stlucia
      </div>
      <p class="auth-card__sub">Set a new password</p>

      <div id="link-invalid" style="display:none;text-align:center;padding:var(--spacing-lg) 0;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--error)" stroke-width="1.5" style="margin:0 auto var(--spacing-md);" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>
        </svg>
        <h2 style="font-size:18px;margin-bottom:var(--spacing-sm);">Link expired or invalid</h2>
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:var(--spacing-lg);">This password reset link has expired or already been used. Request a new one.</p>
        <a href="forgot-password.html" class="btn btn--primary btn--full">Request new link</a>
      </div>

      <div id="reset-done" style="display:none;text-align:center;padding:var(--spacing-lg) 0;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="1.5" style="margin:0 auto var(--spacing-md);" aria-hidden="true">
          <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/>
        </svg>
        <h2 style="font-size:18px;margin-bottom:var(--spacing-sm);">Password updated</h2>
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:var(--spacing-lg);">Your password has been changed. You can now sign in with your new password.</p>
        <a href="login.html" class="btn btn--primary btn--full">Sign in</a>
      </div>

      <form id="reset-form" novalidate>
        <div class="form-group">
          <label class="form-label" for="new-password">New password</label>
          <input class="form-input" type="password" id="new-password" name="password" autocomplete="new-password" placeholder="At least 8 characters" required minlength="8">
          <div class="form-error" id="password-error" role="alert" aria-live="polite" style="display:none;"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="confirm-password">Confirm new password</label>
          <input class="form-input" type="password" id="confirm-password" name="confirm_password" autocomplete="new-password" placeholder="Repeat your new password" required>
          <div class="form-error" id="confirm-error" role="alert" aria-live="polite" style="display:none;"></div>
        </div>

        <button type="submit" class="btn btn--primary btn--full" id="reset-btn">Update password</button>
      </form>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="assets/js/supabase.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
  (function() {
    var form = document.getElementById('reset-form');
    var btn = document.getElementById('reset-btn');
    var newPasswordInput = document.getElementById('new-password');
    var confirmPasswordInput = document.getElementById('confirm-password');
    var passwordError = document.getElementById('password-error');
    var confirmError = document.getElementById('confirm-error');

    function clearErrors() {
      passwordError.style.display = 'none';
      confirmError.style.display = 'none';
      newPasswordInput.style.borderColor = '';
      confirmPasswordInput.style.borderColor = '';
    }

    function showFieldError(field, errorEl, message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      field.style.borderColor = 'var(--error)';
      field.focus();
    }

    /* Supabase sends the recovery token via URL hash — listen for the session */
    db.auth.onAuthStateChange(async function(event, session) {
      if (event === 'PASSWORD_RECOVERY') {
        /* Valid recovery link — form is already visible, nothing else to do */
      } else if (event === 'SIGNED_IN' && window.location.hash.includes('type=recovery')) {
        /* Handled */
      }
    });

    /* If no hash token, show invalid state after a short delay */
    if (!window.location.hash || !window.location.hash.includes('access_token')) {
      setTimeout(function() {
        /* Only hide form if Supabase hasn't detected a valid session by now */
        db.auth.getSession().then(function(result) {
          var session = result.data && result.data.session;
          if (!session) {
            form.style.display = 'none';
            document.getElementById('link-invalid').style.display = 'block';
          }
        });
      }, 400);
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      clearErrors();

      var newPassword = newPasswordInput.value;
      var confirmPassword = confirmPasswordInput.value;

      if (!newPassword || newPassword.length < 8) { showFieldError(newPasswordInput, passwordError, 'Password must be at least 8 characters.'); return; }
      if (newPassword !== confirmPassword) { showFieldError(confirmPasswordInput, confirmError, 'Passwords do not match.'); return; }

      btn.textContent = 'Updating\u2026';
      btn.classList.add('loading');
      btn.disabled = true;

      var result = await db.auth.updateUser({ password: newPassword });

      btn.textContent = 'Update password';
      btn.classList.remove('loading');
      btn.disabled = false;

      if (result.error) {
        showFieldError(newPasswordInput, passwordError, result.error.message || 'Something went wrong. Please try again.');
        return;
      }

      form.style.display = 'none';
      document.getElementById('reset-done').style.display = 'block';
    });
  })();
  </script>
</body>
</html>
